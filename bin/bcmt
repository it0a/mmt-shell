#!/bin/bash
#utility

display_usage() {
    echo "usage: ${0##*/} [-h host] [-P port] [-u user] [-d] [-r]"
    echo "flag;name;description;default"              | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo "====;====;===========;======="              | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo "-h:;host;host of target database;127.0.0.1" | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo "-P:;port;port of target database;3306"      | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo "-u:;user;user of target database;root"      | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo "-d:;dump;dump tables;tables.conf"           | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo "-r:;restore;restore tables;tables.conf"     | awk -F ';' '{printf "%-7s %-10s %-25s %-12s\n", $1, $2, $3, $4}'
    echo ""
    echo "example command;description"                                                                      | awk -F ';' '{printf "%-44s %-62s\n", $1, $2}'
    echo "===============;==========="                                                                      | awk -F ';' '{printf "%-44s %-62s\n", $1, $2}'
    echo "bcmt -d;Dump tables to ./dump from 127.0.0.1:3306 as user 'root'"                                 | awk -F ';' '{printf "%-44s %-62s\n", $1, $2}'
    echo "bcmt -r;Restore tables from ./dump to 127.0.0.1:3306 as user 'root'"                              | awk -F ';' '{printf "%-44s %-62s\n", $1, $2}'
    echo "bcmt -h 10.0.8.190 -d;Dump tables from 10.0.8.190:3306 as user 'root' to ./dump/"                 | awk -F ';' '{printf "%-44s %-62s\n", $1, $2}'
    echo "bcmt -h 10.0.8.190 -P 3308 -u other -r;Restore ./dump/ tables to 10.0.8.190:3308 as user 'other'" | awk -F ';' '{printf "%-44s %-62s\n", $1, $2}'
    exit 0
}
die() {
    echo "ERROR: $* - Aborting."
    exit 1
}
#include
pushd `dirname $0` > /dev/null
SCRIPTPATH=`pwd -P`
popd > /dev/null
. $SCRIPTPATH/includes/dbinit
. $SCRIPTPATH/includes/dumpMeta
. $SCRIPTPATH/includes/restMeta
. $SCRIPTPATH/includes/readConf
#initialize
BCMT_HOST="127.0.0.1"
BCMT_USER="root"
BCMT_PORT="3306"
BCMT_DBNAME=$1
BCMT_INITOK=false
BCMT_RESTORE=false
BCMT_DUMP=false
while getopts h:P:u:dr name
do
    case $name in
        :)
            display_usage
            ;;
        #host
        h)
            BCMT_HOST=$OPTARG
            ;;
        #Port
        P)
            BCMT_PORT=$OPTARG
            ;;
        #user
        u)
            BCMT_USER=$OPTARG
            ;;
        #dump
        d)
            $BCMT_RESTORE && die "Cannot dump and restore."
            BCMT_DUMP=true
            BCMT_INITOK=true
            ;;
        #restore
        r)
            $BCMT_DUMP && die "Cannot dump and restore."
            BCMT_RESTORE=true
            BCMT_INITOK=true
            ;;
        *)
            display_usage
            ;;
    esac
done
if [ $BCMT_INITOK = true ]
then
    do_dbinit
    if [ $BCMT_DBINITOK = true ]
    then
        read_tables
        if [ $BCMT_DUMP = true ]
        then
            for table in "${BCMT_TABLES[@]}"; do dump_table $table; done
        elif [ $BCMT_RESTORE = true ]
        then
            for table in ${BCMT_TABLES[@]}; do restore_table $table; done
        else
            die "Invalid operation"
        fi
    else
        die "Couldn't connect to database"
    fi
else
    display_usage
fi
