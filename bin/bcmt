#!/bin/bash
#utility
display_usage() {
    echo "Usage:"
    echo "${0##*/} [-d] [-r]"
    exit 1
}
die() {
    echo "ERROR: $* - Aborting."
    exit 1
}
#include
pushd `dirname $0` > /dev/null
SCRIPTPATH=`pwd -P`
popd > /dev/null
. $SCRIPTPATH/includes/init
. $SCRIPTPATH/includes/dbinit
. $SCRIPTPATH/includes/dumpMeta
. $SCRIPTPATH/includes/restMeta
. $SCRIPTPATH/includes/readConf
#initialize
BCMT_INITOK=false
BCMT_RESTORE=false
BCMT_DUMP=false
while getopts dr name
do
    case $name in
        d)
            $BCMT_RESTORE && die "Cannot dump and restore."
            BCMT_DUMP=true
            BCMT_INITOK=true
            ;;
        r)
            $BCMT_DUMP && die "Cannot dump and restore."
            BCMT_RESTORE=true
            BCMT_INITOK=true
            ;;
        *)
            echo "Invalid argument specified."
            display_usage
            ;;
    esac
done
if [ $BCMT_INITOK = true ]
then
    do_dbinit
    if [ $BCMT_DBINITOK = "0" ]
    then
        read_tables
        if [ $BCMT_DUMP = true ]
        then
            for table in "${BCMT_TABLES[@]}"; do dump_table $table; done
        elif [ $BCMT_RESTORE = true ]
        then
            for table in ${BCMT_TABLES[@]}; do restore_table $table; done
        else
            die "Invalid operation"
        fi
    else
        die "Couldn't connect to database"
    fi
else
    display_usage
fi
